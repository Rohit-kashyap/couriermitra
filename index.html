<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourierMitra - Super Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 9999; color: white;
        }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; font-weight: 600; }

        /* Header */
        .header {
            background: white;
            padding: 16px 30px;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 16px; margin: 20px; margin-bottom: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header-avatar {
            width: 48px; height: 48px; border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; font-weight: 700;
        }
        .header-info h2 { font-size: 18px; font-weight: 700; color: #1a1a2e; }
        .header-info p { font-size: 13px; color: #6b7280; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .plan-badge {
            padding: 6px 14px; border-radius: 20px;
            background: #ecfdf5; color: #059669;
            font-size: 12px; font-weight: 700; letter-spacing: 0.5px;
            border: 1px solid #a7f3d0;
        }
        .logout-btn {
            padding: 10px 22px; background: #f3f4f6; color: #374151;
            border: 1px solid #e5e7eb; border-radius: 10px;
            cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; }

        /* Container */
        .container { max-width: 1300px; margin: 24px auto; padding: 0 20px; }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; gap: 8px; position: relative; overflow: hidden;
        }
        .stat-card .stat-label {
            font-size: 11px; font-weight: 600; color: #9ca3af;
            text-transform: uppercase; letter-spacing: 0.8px;
        }
        .stat-card .stat-number { font-size: 36px; font-weight: 700; color: #1a1a2e; }
        .stat-card .stat-icon {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            font-size: 42px; opacity: 0.07; color: #667eea;
        }

        /* Dashboard Card (tabs container) */
        .dashboard-card {
            background: white; border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08); overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex; gap: 4px; padding: 16px 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .tab-btn {
            padding: 10px 20px; border: none; background: transparent;
            font-size: 14px; font-weight: 500; color: #6b7280;
            cursor: pointer; border-radius: 8px 8px 0 0;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: #667eea; background: #f5f3ff; }
        .tab-btn.active { color: #667eea; font-weight: 600; border-bottom-color: #667eea; background: transparent; }

        /* Tab Content */
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Search + Action bar */
        .content-bar {
            display: flex; gap: 12px; margin-bottom: 16px; align-items: center;
        }
        .search-wrap { position: relative; flex: 1; }
        .search-wrap i {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #9ca3af; font-size: 14px;
        }
        .search-input {
            width: 100%; padding: 11px 14px 11px 38px;
            border: 1.5px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; color: #374151; transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .filter-select {
            padding: 11px 14px; border: 1.5px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; color: #374151; background: white; cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: #667eea; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        thead tr { border-bottom: 2px solid #f0f0f0; }
        th { padding: 12px 14px; text-align: left; font-size: 12px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.6px; }
        td { padding: 14px; font-size: 14px; color: #374151; border-bottom: 1px solid #f9fafb; }
        tbody tr:hover { background: #fafafa; }
        tbody tr:last-child td { border-bottom: none; }

        /* Badges */
        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
        }
        .badge-active    { background: #ecfdf5; color: #059669; }
        .badge-trial     { background: #eff6ff; color: #2563eb; }
        .badge-suspended { background: #fef2f2; color: #dc2626; }
        .badge-inactive  { background: #f3f4f6; color: #6b7280; }
        .badge-pending   { background: #fffbeb; color: #d97706; }

        .badge-delivered { background: #ecfdf5; color: #059669; }
        .badge-transit   { background: #fffbeb; color: #d97706; }
        .badge-booked    { background: #eff6ff; color: #2563eb; }
        .badge-pickup    { background: #f5f3ff; color: #7c3aed; }
        .badge-hold      { background: #fef2f2; color: #dc2626; }

        /* Plan badge small */
        .plan-tag {
            display: inline-block; padding: 3px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .plan-free    { background: #f3f4f6; color: #6b7280; }
        .plan-starter { background: #eff6ff; color: #2563eb; }
        .plan-growth  { background: #f0fdf4; color: #16a34a; }
        .plan-pro     { background: #faf5ff; color: #7c3aed; }

        /* Action Buttons */
        .action-btns { display: flex; gap: 6px; }
        .btn-icon {
            width: 34px; height: 34px; border: none; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        .btn-icon:hover { transform: translateY(-1px); }
        .btn-view    { background: #667eea; color: white; }
        .btn-edit    { background: #f3f4f6; color: #374151; }
        .btn-delete  { background: #fef2f2; color: #dc2626; }
        .btn-suspend { background: #fff7ed; color: #ea580c; }
        .btn-activate { background: #ecfdf5; color: #059669; }

        /* Client name with avatar */
        .client-name-cell { display: flex; align-items: center; gap: 10px; }
        .client-avatar {
            width: 34px; height: 34px; border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 13px; font-weight: 700; flex-shrink: 0;
        }
        .client-name-cell .name { font-weight: 600; color: #1a1a2e; }
        .client-name-cell .email { font-size: 12px; color: #9ca3af; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.4; }
        .empty-state h3 { font-size: 18px; font-weight: 600; color: #6b7280; margin-bottom: 6px; }
        .empty-state p { font-size: 14px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal {
            background: white; border-radius: 16px; padding: 28px;
            width: 100%; max-width: 520px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: #9ca3af; }
        .modal-close:hover { color: #374151; }
        .modal-body { display: flex; flex-direction: column; gap: 14px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 13px; color: #9ca3af; font-weight: 500; }
        .detail-value { font-size: 14px; color: #1a1a2e; font-weight: 600; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-danger { padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }
        .btn-success { padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }
        .btn-secondary { padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }

        /* Plan select in modal */
        .modal-select {
            width: 100%; padding: 10px 14px; border: 1.5px solid #e5e7eb;
            border-radius: 10px; font-size: 14px; color: #374151;
        }
        .modal-select:focus { outline: none; border-color: #667eea; }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .header { margin: 12px; flex-wrap: wrap; gap: 12px; }
            .container { padding: 0 12px; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Super Admin...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="header-avatar">S</div>
            <div class="header-info">
                <h2>Super Admin</h2>
                <p id="userEmail">Loading...</p>
            </div>
        </div>
        <div class="header-right">
            <span class="plan-badge">SUPER ADMIN</span>
            <button class="logout-btn" onclick="handleLogout()" id="logoutBtn">
                Logout
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Total Clients</span>
                <span class="stat-number" id="statTotalClients">0</span>
                <i class="fas fa-building stat-icon"></i>
            </div>
            <div class="stat-card">
                <span class="stat-label">Active Clients</span>
                <span class="stat-number" id="statActiveClients">0</span>
                <i class="fas fa-check-circle stat-icon"></i>
            </div>
            <div class="stat-card">
                <span class="stat-label">Total Shipments</span>
                <span class="stat-number" id="statTotalShipments">0</span>
                <i class="fas fa-box stat-icon"></i>
            </div>
            <div class="stat-card">
                <span class="stat-label">Trial Accounts</span>
                <span class="stat-number" id="statTrialClients">0</span>
                <i class="fas fa-clock stat-icon"></i>
            </div>
        </div>

        <!-- Dashboard Card -->
        <div class="dashboard-card">

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('clients', this)">
                    <i class="fas fa-building"></i> Clients
                </button>
                <button class="tab-btn" onclick="switchTab('shipments', this)">
                    <i class="fas fa-box"></i> Shipments
                </button>
            </div>

            <!-- CLIENTS TAB -->
            <div id="tab-clients" class="tab-content active">
                <div class="content-bar">
                    <div class="search-wrap">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="clientSearch" placeholder="Search by company name or email..." oninput="filterClients()">
                    </div>
                    <select class="filter-select" id="clientStatusFilter" onchange="filterClients()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="trial">Trial</option>
                        <option value="suspended">Suspended</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                    <select class="filter-select" id="clientPlanFilter" onchange="filterClients()">
                        <option value="">All Plans</option>
                        <option value="free">Free</option>
                        <option value="starter">Starter</option>
                        <option value="growth">Growth</option>
                        <option value="pro">Pro</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Shipments</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTable"></tbody>
                </table>
                <div id="clientsEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-building"></i>
                    <h3>No Clients Found</h3>
                    <p>No registered courier businesses yet</p>
                </div>
            </div>

            <!-- SHIPMENTS TAB -->
            <div id="tab-shipments" class="tab-content">
                <div class="content-bar">
                    <div class="search-wrap">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="shipmentSearch" placeholder="Search by AWB, consignee, destination..." oninput="filterShipments()">
                    </div>
                    <select class="filter-select" id="shipmentStatusFilter" onchange="filterShipments()">
                        <option value="">All Statuses</option>
                        <option value="Booked">Booked</option>
                        <option value="Picked Up">Picked Up</option>
                        <option value="In Transit">In Transit</option>
                        <option value="Out for Delivery">Out for Delivery</option>
                        <option value="Delivered">Delivered</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>AWB</th>
                            <th>Client</th>
                            <th>Consignee</th>
                            <th>Destination</th>
                            <th>Status</th>
                            <th>Booking Date</th>
                        </tr>
                    </thead>
                    <tbody id="shipmentsTable"></tbody>
                </table>
                <div id="shipmentsEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-box-open"></i>
                    <h3>No Shipments Found</h3>
                    <p>No shipments across all clients yet</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="clientModal" class="modal-overlay" style="display:none;" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Client Details</h3>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // SUPABASE
        // ============================================================
        const SUPABASE_URL = 'https://cptzvucszoaolehariwu.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_JRUmY_u6soJB11pkWipNEg_HKkRZ0jh';
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================================
        // STATE
        // ============================================================
        let allClients = [];
        let allShipments = [];

        // ============================================================
        // INIT
        // ============================================================
        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { user }, error } = await window.supabaseClient.auth.getUser();
            if (error || !user) { window.location.href = 'login.html'; return; }

            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('loadingScreen').style.display = 'none';

            await Promise.all([loadClients(), loadShipments()]);
        });

        // ============================================================
        // TABS
        // ============================================================
        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // ============================================================
        // LOAD CLIENTS
        // ============================================================
        async function loadClients() {
            const { data, error } = await window.supabaseClient
                .from('clients')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) { console.error('Clients load error:', error); return; }
            allClients = data || [];
            renderClients(allClients);
            updateStats();
        }

        function renderClients(clients) {
            const tbody = document.getElementById('clientsTable');
            const empty = document.getElementById('clientsEmpty');

            if (!clients.length) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            tbody.innerHTML = clients.map(c => {
                const initial = (c.company_name || c.email || 'C')[0].toUpperCase();
                const statusBadge = getStatusBadge(c.subscription_status, c.is_active);
                const planTag = getPlanTag(c.plan);
                const shipmentCount = allShipments.filter(s => s.client_id === c.id).length;
                const joined = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : '—';
                const isSuspended = !c.is_active;

                return `<tr>
                    <td>
                        <div class="client-name-cell">
                            <div class="client-avatar">${escHtml(initial)}</div>
                            <div>
                                <div class="name">${escHtml(c.company_name || '—')}</div>
                                <div class="email">${escHtml(c.email || '')}</div>
                            </div>
                        </div>
                    </td>
                    <td>${planTag}</td>
                    <td>${statusBadge}</td>
                    <td>${shipmentCount}</td>
                    <td>${joined}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-icon btn-view" onclick="viewClient('${c.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-edit" onclick="changePlan('${c.id}')" title="Change Plan">
                                <i class="fas fa-tag"></i>
                            </button>
                            ${isSuspended
                                ? `<button class="btn-icon btn-activate" onclick="toggleClient('${c.id}', true)" title="Activate">
                                       <i class="fas fa-check"></i>
                                   </button>`
                                : `<button class="btn-icon btn-suspend" onclick="toggleClient('${c.id}', false)" title="Suspend">
                                       <i class="fas fa-ban"></i>
                                   </button>`
                            }
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterClients() {
            const search = document.getElementById('clientSearch').value.toLowerCase();
            const status = document.getElementById('clientStatusFilter').value.toLowerCase();
            const plan   = document.getElementById('clientPlanFilter').value.toLowerCase();

            const filtered = allClients.filter(c => {
                const matchSearch = !search ||
                    (c.company_name || '').toLowerCase().includes(search) ||
                    (c.email || '').toLowerCase().includes(search);
                const matchStatus = !status || getStatusKey(c.subscription_status, c.is_active) === status;
                const matchPlan   = !plan   || (c.plan || '').toLowerCase() === plan;
                return matchSearch && matchStatus && matchPlan;
            });
            renderClients(filtered);
        }

        // ============================================================
        // LOAD SHIPMENTS
        // ============================================================
        async function loadShipments() {
            const { data, error } = await window.supabaseClient
                .from('shipments')
                .select('*, clients(company_name)')
                .order('created_at', { ascending: false });

            if (error) { console.error('Shipments load error:', error); return; }
            allShipments = data || [];
            renderShipments(allShipments);
            updateStats();
        }

        function renderShipments(shipments) {
            const tbody = document.getElementById('shipmentsTable');
            const empty = document.getElementById('shipmentsEmpty');

            if (!shipments.length) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            tbody.innerHTML = shipments.map(s => {
                const clientName = s.clients ? escHtml(s.clients.company_name || '—') : '—';
                const date = s.booking_date ? new Date(s.booking_date).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : '—';
                return `<tr>
                    <td><strong>${escHtml(s.awb_no || '—')}</strong></td>
                    <td>${clientName}</td>
                    <td>${escHtml(s.consignee_name || '—')}</td>
                    <td>${escHtml(s.consignee_city ? s.consignee_city + (s.consignee_country ? ', ' + s.consignee_country : '') : '—')}</td>
                    <td>${getShipmentBadge(s.status)}</td>
                    <td>${date}</td>
                </tr>`;
            }).join('');
        }

        function filterShipments() {
            const search = document.getElementById('shipmentSearch').value.toLowerCase();
            const status = document.getElementById('shipmentStatusFilter').value;

            const filtered = allShipments.filter(s => {
                const matchSearch = !search ||
                    (s.awb_no || '').toLowerCase().includes(search) ||
                    (s.consignee_name || '').toLowerCase().includes(search) ||
                    (s.consignee_city || '').toLowerCase().includes(search) ||
                    (s.consignee_country || '').toLowerCase().includes(search);
                const matchStatus = !status || s.status === status;
                return matchSearch && matchStatus;
            });
            renderShipments(filtered);
        }

        // ============================================================
        // STATS
        // ============================================================
        function updateStats() {
            document.getElementById('statTotalClients').textContent = allClients.length;
            document.getElementById('statActiveClients').textContent = allClients.filter(c => c.is_active).length;
            document.getElementById('statTotalShipments').textContent = allShipments.length;
            document.getElementById('statTrialClients').textContent = allClients.filter(c =>
                (c.subscription_status || '').toLowerCase() === 'trial' ||
                (c.subscription_status || '').toLowerCase() === 'pending'
            ).length;
        }

        // ============================================================
        // CLIENT ACTIONS
        // ============================================================
        function viewClient(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;

            const shipmentCount = allShipments.filter(s => s.client_id === id).length;
            const joined = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : '—';

            document.getElementById('modalTitle').textContent = c.company_name || c.email;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">Company</span><span class="detail-value">${escHtml(c.company_name || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${escHtml(c.email || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">Phone</span><span class="detail-value">${escHtml(c.phone || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">Address</span><span class="detail-value">${escHtml(c.address || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">AWB Prefix</span><span class="detail-value">${escHtml(c.awb_prefix || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">Plan</span><span class="detail-value">${getPlanTag(c.plan)}</span></div>
                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value">${getStatusBadge(c.subscription_status, c.is_active)}</span></div>
                <div class="detail-row"><span class="detail-label">Shipments</span><span class="detail-value">${shipmentCount}</span></div>
                <div class="detail-row"><span class="detail-label">Joined</span><span class="detail-value">${joined}</span></div>
            `;
            document.getElementById('modalActions').innerHTML = `
                <button class="btn-secondary" onclick="closeClientModal()">Close</button>
                ${c.is_active
                    ? `<button class="btn-danger" onclick="toggleClient('${id}', false); closeClientModal()">Suspend Account</button>`
                    : `<button class="btn-success" onclick="toggleClient('${id}', true); closeClientModal()">Activate Account</button>`
                }
            `;
            document.getElementById('clientModal').style.display = 'flex';
        }

        function changePlan(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('modalTitle').textContent = 'Change Plan — ' + (c.company_name || c.email);
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">Company</span><span class="detail-value">${escHtml(c.company_name || '—')}</span></div>
                <div class="detail-row"><span class="detail-label">Current Plan</span><span class="detail-value">${getPlanTag(c.plan)}</span></div>
                <div class="detail-row">
                    <span class="detail-label">New Plan</span>
                    <select class="modal-select" id="newPlanSelect" style="width:auto;">
                        <option value="free" ${c.plan==='free'?'selected':''}>Free</option>
                        <option value="starter" ${c.plan==='starter'?'selected':''}>Starter — ₹999/mo</option>
                        <option value="growth" ${c.plan==='growth'?'selected':''}>Growth — ₹2,499/mo</option>
                        <option value="pro" ${c.plan==='pro'?'selected':''}>Pro — ₹4,999/mo</option>
                    </select>
                </div>
                <div class="detail-row">
                    <span class="detail-label">New Status</span>
                    <select class="modal-select" id="newStatusSelect" style="width:auto;">
                        <option value="trial" ${(c.subscription_status||'')==='trial'?'selected':''}>Trial</option>
                        <option value="active" ${(c.subscription_status||'')==='active'?'selected':''}>Active</option>
                        <option value="inactive" ${(c.subscription_status||'')==='inactive'?'selected':''}>Inactive</option>
                        <option value="suspended" ${(c.subscription_status||'')==='suspended'?'selected':''}>Suspended</option>
                        <option value="pending" ${(c.subscription_status||'')==='pending'?'selected':''}>Pending</option>
                    </select>
                </div>
            `;
            document.getElementById('modalActions').innerHTML = `
                <button class="btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn-success" onclick="savePlanChange('${id}')">Save Changes</button>
            `;
            document.getElementById('clientModal').style.display = 'flex';
        }

        async function savePlanChange(id) {
            const plan   = document.getElementById('newPlanSelect').value;
            const status = document.getElementById('newStatusSelect').value;

            const { error } = await window.supabaseClient
                .from('clients')
                .update({ plan, subscription_status: status })
                .eq('id', id);

            if (error) { alert('Error saving: ' + error.message); return; }

            // Update local state
            const idx = allClients.findIndex(x => x.id === id);
            if (idx !== -1) { allClients[idx].plan = plan; allClients[idx].subscription_status = status; }

            closeClientModal();
            filterClients();
            updateStats();
        }

        async function toggleClient(id, activate) {
            const action = activate ? 'activate' : 'suspend';
            if (!confirm(`Are you sure you want to ${action} this account?`)) return;

            const { error } = await window.supabaseClient
                .from('clients')
                .update({ is_active: activate })
                .eq('id', id);

            if (error) { alert('Error: ' + error.message); return; }

            const idx = allClients.findIndex(x => x.id === id);
            if (idx !== -1) allClients[idx].is_active = activate;

            filterClients();
            updateStats();
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function closeModalOnOverlay(e) {
            if (e.target === document.getElementById('clientModal')) closeClientModal();
        }

        // ============================================================
        // LOGOUT
        // ============================================================
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            const btn = document.getElementById('logoutBtn');
            btn.textContent = 'Logging out...'; btn.disabled = true;
            await window.supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function escHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function getStatusKey(subscription_status, is_active) {
            if (!is_active) return 'suspended';
            const s = (subscription_status || '').toLowerCase();
            return s || 'pending';
        }

        function getStatusBadge(subscription_status, is_active) {
            const key = getStatusKey(subscription_status, is_active);
            const labels = { active:'Active', trial:'Trial', suspended:'Suspended', inactive:'Inactive', pending:'Pending' };
            const cls    = { active:'badge-active', trial:'badge-trial', suspended:'badge-suspended', inactive:'badge-inactive', pending:'badge-pending' };
            return `<span class="badge ${cls[key] || 'badge-pending'}">${labels[key] || key}</span>`;
        }

        function getPlanTag(plan) {
            const p = (plan || 'free').toLowerCase();
            const labels = { free:'Free', starter:'Starter', growth:'Growth', pro:'Pro' };
            return `<span class="plan-tag plan-${p}">${labels[p] || p}</span>`;
        }

        function getShipmentBadge(status) {
            const map = {
                'Delivered':       'badge-delivered',
                'In Transit':      'badge-transit',
                'Out for Delivery':'badge-transit',
                'Booked':          'badge-booked',
                'Picked Up':       'badge-pickup',
                'On Hold':         'badge-hold',
            };
            const cls = map[status] || 'badge-booked';
            return `<span class="badge ${cls}">${escHtml(status || '—')}</span>`;
        }
    </script>
</body>
</html>

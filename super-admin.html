<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourierMitra - Super Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6fb;
            min-height: 100vh;
        }

        /* â”€â”€ Loading â”€â”€ */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 9999; color: white;
        }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; font-weight: 600; }

        /* â”€â”€ Layout â”€â”€ */
        .app-layout { display: flex; min-height: 100vh; }

        /* â”€â”€ Sidebar â”€â”€ */
        .sidebar {
            width: 240px; background: #1a1a2e; color: white;
            display: flex; flex-direction: column;
            position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
        }
        .sidebar-logo {
            padding: 24px 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .logo-company { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .logo-icon { font-size: 22px; }
        .logo-text { font-size: 17px; font-weight: 700; color: white; }
        .logo-powered { font-size: 10px; color: rgba(255,255,255,0.35); padding-left: 32px; }

        .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 11px 14px; border-radius: 10px;
            color: rgba(255,255,255,0.6); font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; border: none; background: none; width: 100%; text-align: left;
        }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
        .nav-item.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 600; }
        .nav-item i { width: 16px; text-align: center; font-size: 14px; }

        .sidebar-bottom {
            padding: 16px 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .sidebar-user {
            display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
            padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,0.06);
        }
        .sidebar-avatar {
            width: 34px; height: 34px; border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700; flex-shrink: 0;
        }
        .sidebar-user-info { overflow: hidden; }
        .sidebar-user-name { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar-user-role { font-size: 11px; color: rgba(255,255,255,0.45); }
        .sidebar-logout {
            display: flex; align-items: center; gap: 10px;
            width: 100%; padding: 10px 14px; border-radius: 10px;
            background: none; border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.55); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .sidebar-logout:hover { background: rgba(220,38,38,0.15); color: #f87171; border-color: rgba(248,113,113,0.3); }

        /* â”€â”€ Main Content â”€â”€ */
        .main-content { margin-left: 240px; flex: 1; padding: 28px; min-height: 100vh; }

        /* â”€â”€ Top bar â”€â”€ */
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px;
        }
        .page-title { font-size: 22px; font-weight: 700; color: #1a1a2e; }
        .page-subtitle { font-size: 13px; color: #9ca3af; margin-top: 2px; }
        .super-badge {
            padding: 6px 14px; border-radius: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; font-size: 11px; font-weight: 700; letter-spacing: 0.8px;
        }

        /* â”€â”€ Stats Grid â”€â”€ */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: white; padding: 22px 20px; border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; gap: 6px; position: relative; overflow: hidden;
        }
        .stat-card .stat-label {
            font-size: 11px; font-weight: 600; color: #9ca3af;
            text-transform: uppercase; letter-spacing: 0.8px;
        }
        .stat-card .stat-number { font-size: 32px; font-weight: 700; color: #1a1a2e; }
        .stat-card .stat-change { font-size: 12px; color: #059669; font-weight: 500; }
        .stat-card .stat-icon {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            font-size: 38px; opacity: 0.07; color: #667eea;
        }
        .stat-mrr .stat-number { color: #059669; }
        .stat-mrr .stat-icon { color: #059669; }

        /* â”€â”€ Dashboard Card â”€â”€ */
        .dashboard-card {
            background: white; border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); overflow: hidden;
        }

        /* â”€â”€ Tabs â”€â”€ */
        .tabs {
            display: flex; gap: 4px; padding: 16px 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .tab-btn {
            padding: 10px 18px; border: none; background: transparent;
            font-size: 14px; font-weight: 500; color: #6b7280;
            cursor: pointer; border-radius: 8px 8px 0 0;
            border-bottom: 2px solid transparent; transition: all 0.2s;
            display: flex; align-items: center; gap: 7px;
        }
        .tab-btn:hover { color: #667eea; background: #f5f3ff; }
        .tab-btn.active { color: #667eea; font-weight: 600; border-bottom-color: #667eea; }

        /* â”€â”€ Tab Content â”€â”€ */
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* â”€â”€ Content bar â”€â”€ */
        .content-bar { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; }
        .search-wrap { position: relative; flex: 1; }
        .search-wrap i { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 13px; }
        .search-input {
            width: 100%; padding: 10px 13px 10px 36px;
            border: 1.5px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; color: #374151; transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .filter-select {
            padding: 10px 13px; border: 1.5px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; color: #374151; background: white; cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: #667eea; }

        /* â”€â”€ Table â”€â”€ */
        table { width: 100%; border-collapse: collapse; }
        thead tr { border-bottom: 2px solid #f0f0f0; }
        th { padding: 11px 14px; text-align: left; font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.6px; }
        td { padding: 13px 14px; font-size: 14px; color: #374151; border-bottom: 1px solid #f9fafb; }
        tbody tr:hover { background: #fafafa; }
        tbody tr:last-child td { border-bottom: none; }

        /* â”€â”€ Badges â”€â”€ */
        .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-active    { background: #ecfdf5; color: #059669; }
        .badge-trial     { background: #eff6ff; color: #2563eb; }
        .badge-suspended { background: #fef2f2; color: #dc2626; }
        .badge-inactive  { background: #f3f4f6; color: #6b7280; }
        .badge-pending   { background: #fffbeb; color: #d97706; }
        .badge-delivered { background: #ecfdf5; color: #059669; }
        .badge-transit   { background: #fffbeb; color: #d97706; }
        .badge-booked    { background: #eff6ff; color: #2563eb; }
        .badge-pickup    { background: #f5f3ff; color: #7c3aed; }
        .badge-hold      { background: #fef2f2; color: #dc2626; }

        .plan-tag { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .plan-free    { background: #f3f4f6; color: #6b7280; }
        .plan-starter { background: #eff6ff; color: #2563eb; }
        .plan-growth  { background: #f0fdf4; color: #16a34a; }
        .plan-pro     { background: #faf5ff; color: #7c3aed; }

        /* â”€â”€ Action Buttons â”€â”€ */
        .action-btns { display: flex; gap: 5px; }
        .btn-icon {
            width: 32px; height: 32px; border: none; border-radius: 7px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 13px; transition: all 0.2s;
        }
        .btn-icon:hover { transform: translateY(-1px); }
        .btn-view    { background: #eff6ff; color: #2563eb; }
        .btn-edit    { background: #f3f4f6; color: #374151; }
        .btn-delete  { background: #fef2f2; color: #dc2626; }
        .btn-suspend { background: #fff7ed; color: #ea580c; }
        .btn-activate { background: #ecfdf5; color: #059669; }
        .btn-tag     { background: #f5f3ff; color: #7c3aed; }

        /* â”€â”€ Client name cell â”€â”€ */
        .client-name-cell { display: flex; align-items: center; gap: 10px; }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px; font-weight: 700; flex-shrink: 0;
        }
        .client-name-cell .name { font-weight: 600; color: #1a1a2e; font-size: 13px; }
        .client-name-cell .email { font-size: 11px; color: #9ca3af; }

        /* â”€â”€ Empty State â”€â”€ */
        .empty-state { text-align: center; padding: 50px 20px; color: #9ca3af; }
        .empty-state i { font-size: 42px; margin-bottom: 14px; display: block; opacity: 0.4; }
        .empty-state h3 { font-size: 17px; font-weight: 600; color: #6b7280; margin-bottom: 5px; }
        .empty-state p { font-size: 13px; }

        /* â”€â”€ Revenue Tab â”€â”€ */
        .revenue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .rev-card { background: #f9fafb; border-radius: 12px; padding: 20px; }
        .rev-card h4 { font-size: 12px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 14px; }
        .plan-breakdown-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid #e5e7eb;
        }
        .plan-breakdown-row:last-child { border-bottom: none; }
        .plan-breakdown-left { display: flex; align-items: center; gap: 10px; }
        .plan-breakdown-count { font-size: 13px; color: #374151; font-weight: 500; }
        .plan-breakdown-rev { font-size: 13px; font-weight: 700; color: #1a1a2e; }

        .signup-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 9px 0; border-bottom: 1px solid #e5e7eb;
        }
        .signup-item:last-child { border-bottom: none; }
        .signup-left { display: flex; align-items: center; gap: 10px; }
        .signup-avatar { width: 28px; height: 28px; border-radius: 7px; background: linear-gradient(135deg,#667eea,#764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 700; }
        .signup-name { font-size: 13px; font-weight: 600; color: #1a1a2e; }
        .signup-date { font-size: 11px; color: #9ca3af; }
        .mrr-total { font-size: 28px; font-weight: 700; color: #059669; margin-top: 6px; }
        .mrr-label { font-size: 12px; color: #6b7280; margin-top: 4px; }

        /* â”€â”€ Modal â”€â”€ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal {
            background: white; border-radius: 16px; padding: 28px;
            width: 100%; max-width: 520px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-weight: 700; color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: #9ca3af; line-height: 1; }
        .modal-close:hover { color: #374151; }
        .modal-body { display: flex; flex-direction: column; gap: 12px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid #f3f4f6; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 13px; color: #9ca3af; font-weight: 500; }
        .detail-value { font-size: 14px; color: #1a1a2e; font-weight: 600; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-danger    { padding: 10px 18px; background: #dc2626; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }
        .btn-success   { padding: 10px 18px; background: #059669; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }
        .btn-secondary { padding: 10px 18px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }
        .btn-warning   { padding: 10px 18px; background: #f59e0b; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; }

        .modal-select, .modal-input {
            width: 100%; padding: 10px 13px; border: 1.5px solid #e5e7eb;
            border-radius: 10px; font-size: 14px; color: #374151; font-family: inherit;
        }
        .modal-select:focus, .modal-input:focus { outline: none; border-color: #667eea; }

        .form-label { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; display: block; }
        .form-field { display: flex; flex-direction: column; gap: 5px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 1000px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .revenue-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 700px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Super Admin...</div>
    </div>

    <div class="app-layout">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-company">
                    <span class="logo-icon">ðŸ“¦</span>
                    <span class="logo-text">CourierMitra</span>
                </div>
                <div class="logo-powered">Super Admin Panel</div>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="switchTab('clients', this)" data-tab="clients">
                    <i class="fas fa-building"></i> Clients
                </button>
                <button class="nav-item" onclick="switchTab('shipments', this)" data-tab="shipments">
                    <i class="fas fa-box"></i> Shipments
                </button>
                <button class="nav-item" onclick="switchTab('revenue', this)" data-tab="revenue">
                    <i class="fas fa-chart-line"></i> Revenue
                </button>
            </nav>

            <div class="sidebar-bottom">
                <div class="sidebar-user">
                    <div class="sidebar-avatar">R</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="userEmail">Loading...</div>
                        <div class="sidebar-user-role">Super Admin</div>
                    </div>
                </div>
                <button class="sidebar-logout" onclick="handleLogout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="main-content">

            <!-- Top Bar -->
            <div class="topbar">
                <div>
                    <div class="page-title" id="pageTitle">Clients</div>
                    <div class="page-subtitle" id="pageSubtitle">Manage all courier operator accounts</div>
                </div>
                <span class="super-badge">SUPER ADMIN</span>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">Total Clients</span>
                    <span class="stat-number" id="statTotalClients">0</span>
                    <i class="fas fa-building stat-icon"></i>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Active Clients</span>
                    <span class="stat-number" id="statActiveClients">0</span>
                    <i class="fas fa-check-circle stat-icon"></i>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Shipments</span>
                    <span class="stat-number" id="statTotalShipments">0</span>
                    <i class="fas fa-box stat-icon"></i>
                </div>
                <div class="stat-card stat-mrr">
                    <span class="stat-label">Est. MRR</span>
                    <span class="stat-number" id="statMRR">â‚¹0</span>
                    <i class="fas fa-rupee-sign stat-icon"></i>
                </div>
            </div>

            <!-- Dashboard Card -->
            <div class="dashboard-card">

                <!-- CLIENTS TAB -->
                <div id="tab-clients" class="tab-content active">
                    <div class="content-bar">
                        <div class="search-wrap">
                            <i class="fas fa-search"></i>
                            <input type="text" class="search-input" id="clientSearch" placeholder="Search company or email..." oninput="filterClients()">
                        </div>
                        <select class="filter-select" id="clientStatusFilter" onchange="filterClients()">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="trial">Trial</option>
                            <option value="suspended">Suspended</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                        <select class="filter-select" id="clientPlanFilter" onchange="filterClients()">
                            <option value="">All Plans</option>
                            <option value="free">Free</option>
                            <option value="starter">Starter</option>
                            <option value="growth">Growth</option>
                            <option value="pro">Pro</option>
                        </select>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Plan</th>
                                <th>Status</th>
                                <th>Shipments</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTable"></tbody>
                    </table>
                    <div id="clientsEmpty" class="empty-state" style="display:none;">
                        <i class="fas fa-building"></i>
                        <h3>No Clients Found</h3>
                        <p>No registered courier businesses yet</p>
                    </div>
                </div>

                <!-- SHIPMENTS TAB -->
                <div id="tab-shipments" class="tab-content">
                    <div class="content-bar">
                        <div class="search-wrap">
                            <i class="fas fa-search"></i>
                            <input type="text" class="search-input" id="shipmentSearch" placeholder="Search AWB, consignee, destination..." oninput="filterShipments()">
                        </div>
                        <select class="filter-select" id="shipmentClientFilter" onchange="filterShipments()">
                            <option value="">All Clients</option>
                        </select>
                        <select class="filter-select" id="shipmentStatusFilter" onchange="filterShipments()">
                            <option value="">All Statuses</option>
                            <option value="Booked">Booked</option>
                            <option value="Picked Up">Picked Up</option>
                            <option value="In Transit">In Transit</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>AWB</th>
                                <th>Client</th>
                                <th>Consignee</th>
                                <th>Destination</th>
                                <th>Carrier</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="shipmentsTable"></tbody>
                    </table>
                    <div id="shipmentsEmpty" class="empty-state" style="display:none;">
                        <i class="fas fa-box-open"></i>
                        <h3>No Shipments Found</h3>
                        <p>No shipments across all clients yet</p>
                    </div>
                </div>

                <!-- REVENUE TAB -->
                <div id="tab-revenue" class="tab-content">
                    <div class="revenue-grid">
                        <!-- MRR Summary -->
                        <div class="rev-card">
                            <h4>Monthly Recurring Revenue</h4>
                            <div class="mrr-total" id="revMRR">â‚¹0</div>
                            <div class="mrr-label" id="revMRRLabel">from 0 paid clients</div>
                            <div style="margin-top:20px;padding-top:16px;border-top:1px solid #e5e7eb;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span style="font-size:12px;color:#9ca3af;">Free clients</span>
                                    <span style="font-size:13px;font-weight:600;" id="revFreeCount">0</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span style="font-size:12px;color:#9ca3af;">Paid clients</span>
                                    <span style="font-size:13px;font-weight:600;color:#059669;" id="revPaidCount">0</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;">
                                    <span style="font-size:12px;color:#9ca3af;">Pending/Trial</span>
                                    <span style="font-size:13px;font-weight:600;color:#d97706;" id="revPendingCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Plan Breakdown -->
                        <div class="rev-card">
                            <h4>Plan Breakdown</h4>
                            <div id="planBreakdown"></div>
                        </div>

                        <!-- Recent Signups -->
                        <div class="rev-card" style="grid-column: 1 / -1;">
                            <h4>Recent Signups (Last 10)</h4>
                            <div id="recentSignups"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Client Detail / Action Modal -->
    <div id="clientModal" class="modal-overlay" style="display:none;" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Client Details</h3>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // SUPABASE
        // ============================================================
        const SUPABASE_URL = 'https://cptzvucszoaolehariwu.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_JRUmY_u6soJB11pkWipNEg_HKkRZ0jh';
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const SESSION_KEY = 'cm_super_admin';

        // Plan pricing (monthly)
        const PLAN_PRICES = { free: 0, starter: 999, growth: 2499, pro: 4999 };

        // ============================================================
        // STATE
        // ============================================================
        let allClients = [];
        let allShipments = [];

        // ============================================================
        // INIT
        // ============================================================
        window.addEventListener('DOMContentLoaded', async () => {
            // Check independent super admin session (not tied to Supabase auth)
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') {
                window.location.href = 'super-admin-login.html';
                return;
            }

            document.getElementById('userEmail').textContent = 'designer.rohitkashyap@gmail.com';
            document.getElementById('loadingScreen').style.display = 'none';

            await Promise.all([loadClients(), loadShipments()]);
        });

        // ============================================================
        // TABS
        // ============================================================
        const PAGE_META = {
            clients:   { title: 'Clients',   subtitle: 'Manage all courier operator accounts' },
            shipments: { title: 'Shipments', subtitle: 'All shipments across every client' },
            revenue:   { title: 'Revenue',   subtitle: 'MRR, plan breakdown and recent signups' },
        };

        function switchTab(tab, btn) {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('pageTitle').textContent    = PAGE_META[tab].title;
            document.getElementById('pageSubtitle').textContent = PAGE_META[tab].subtitle;
            if (tab === 'revenue') renderRevenue();
        }

        // ============================================================
        // LOAD CLIENTS
        // ============================================================
        async function loadClients() {
            const { data, error } = await window.supabaseClient
                .from('clients')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) { console.error('Clients load error:', error); return; }
            allClients = data || [];
            renderClients(allClients);
            updateStats();
            populateClientFilter();
        }

        function renderClients(clients) {
            const tbody = document.getElementById('clientsTable');
            const empty = document.getElementById('clientsEmpty');

            if (!clients.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';

            tbody.innerHTML = clients.map(c => {
                const initial = (c.company_name || c.email || 'C')[0].toUpperCase();
                const shipmentCount = allShipments.filter(s => s.client_id === c.id).length;
                const joined = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';

                return `<tr>
                    <td>
                        <div class="client-name-cell">
                            <div class="client-avatar">${esc(initial)}</div>
                            <div>
                                <div class="name">${esc(c.company_name || 'â€”')}</div>
                                <div class="email">${esc(c.email || '')}</div>
                            </div>
                        </div>
                    </td>
                    <td>${getPlanTag(c.plan)}</td>
                    <td>${getStatusBadge(c.subscription_status, c.is_active)}</td>
                    <td>${shipmentCount}</td>
                    <td>${joined}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-icon btn-view"    onclick="viewClient('${c.id}')"    title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon btn-edit"    onclick="editClient('${c.id}')"    title="Edit Details"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon btn-tag"     onclick="changePlan('${c.id}')"    title="Change Plan / Status"><i class="fas fa-tag"></i></button>
                            ${c.is_active
                                ? `<button class="btn-icon btn-suspend" onclick="toggleClient('${c.id}', false)" title="Suspend"><i class="fas fa-ban"></i></button>`
                                : `<button class="btn-icon btn-activate" onclick="toggleClient('${c.id}', true)" title="Activate"><i class="fas fa-check"></i></button>`
                            }
                            <button class="btn-icon btn-delete"  onclick="deleteClient('${c.id}')" title="Delete Client"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterClients() {
            const search = document.getElementById('clientSearch').value.toLowerCase();
            const status = document.getElementById('clientStatusFilter').value.toLowerCase();
            const plan   = document.getElementById('clientPlanFilter').value.toLowerCase();

            const filtered = allClients.filter(c => {
                const matchSearch = !search || (c.company_name||'').toLowerCase().includes(search) || (c.email||'').toLowerCase().includes(search);
                const matchStatus = !status || getStatusKey(c.subscription_status, c.is_active) === status;
                const matchPlan   = !plan   || (c.plan||'').toLowerCase() === plan;
                return matchSearch && matchStatus && matchPlan;
            });
            renderClients(filtered);
        }

        // ============================================================
        // LOAD SHIPMENTS
        // ============================================================
        async function loadShipments() {
            const { data, error } = await window.supabaseClient
                .from('shipments')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) { console.error('Shipments load error:', error); return; }
            allShipments = data || [];
            renderShipments(allShipments);
            updateStats();
        }

        function populateClientFilter() {
            const sel = document.getElementById('shipmentClientFilter');
            allClients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.company_name || c.email;
                sel.appendChild(opt);
            });
        }

        function getClientName(clientId) {
            const c = allClients.find(x => x.id === clientId);
            return c ? (c.company_name || c.email || 'â€”') : 'â€”';
        }

        function renderShipments(shipments) {
            const tbody = document.getElementById('shipmentsTable');
            const empty = document.getElementById('shipmentsEmpty');

            if (!shipments.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';

            tbody.innerHTML = shipments.map(s => {
                const date = s.booking_date ? new Date(s.booking_date).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
                const dest = [s.consignee_city, s.consignee_country].filter(Boolean).join(', ') || 'â€”';
                return `<tr>
                    <td><strong>${esc(s.awb_no || 'â€”')}</strong></td>
                    <td style="font-size:12px;">${esc(getClientName(s.client_id))}</td>
                    <td>${esc(s.consignee_name || 'â€”')}</td>
                    <td style="font-size:12px;">${esc(dest)}</td>
                    <td style="font-size:12px;">${esc(s.carrier_name || 'â€”')}</td>
                    <td>${getShipmentBadge(s.status)}</td>
                    <td style="font-size:12px;">${date}</td>
                </tr>`;
            }).join('');
        }

        function filterShipments() {
            const search   = document.getElementById('shipmentSearch').value.toLowerCase();
            const clientId = document.getElementById('shipmentClientFilter').value;
            const status   = document.getElementById('shipmentStatusFilter').value;

            const filtered = allShipments.filter(s => {
                const matchSearch = !search ||
                    (s.awb_no||'').toLowerCase().includes(search) ||
                    (s.consignee_name||'').toLowerCase().includes(search) ||
                    (s.consignee_city||'').toLowerCase().includes(search) ||
                    (s.consignee_country||'').toLowerCase().includes(search);
                const matchClient = !clientId || s.client_id === clientId;
                const matchStatus = !status   || s.status === status;
                return matchSearch && matchClient && matchStatus;
            });
            renderShipments(filtered);
        }

        // ============================================================
        // REVENUE TAB
        // ============================================================
        function renderRevenue() {
            const planCounts = { free: 0, starter: 0, growth: 0, pro: 0 };
            let mrr = 0;
            let paidCount = 0;
            let pendingCount = 0;

            allClients.forEach(c => {
                const plan = (c.plan || 'free').toLowerCase();
                planCounts[plan] = (planCounts[plan] || 0) + 1;
                const price = PLAN_PRICES[plan] || 0;
                if (price > 0 && c.is_active) { mrr += price; paidCount++; }
                const status = (c.subscription_status || '').toLowerCase();
                if (status === 'pending' || status === 'trial') pendingCount++;
            });

            document.getElementById('revMRR').textContent = 'â‚¹' + mrr.toLocaleString('en-IN');
            document.getElementById('revMRRLabel').textContent = `from ${paidCount} paid client${paidCount !== 1 ? 's' : ''}`;
            document.getElementById('revFreeCount').textContent = planCounts.free || 0;
            document.getElementById('revPaidCount').textContent = paidCount;
            document.getElementById('revPendingCount').textContent = pendingCount;

            // Plan breakdown
            const planLabels = { free: 'Free', starter: 'Starter', growth: 'Growth', pro: 'Pro' };
            document.getElementById('planBreakdown').innerHTML = Object.keys(planCounts).map(p => {
                const count = planCounts[p] || 0;
                const rev = PLAN_PRICES[p] * count;
                return `<div class="plan-breakdown-row">
                    <div class="plan-breakdown-left">
                        ${getPlanTag(p)}
                        <span class="plan-breakdown-count">${count} client${count !== 1 ? 's' : ''}</span>
                    </div>
                    <span class="plan-breakdown-rev">${PLAN_PRICES[p] > 0 ? 'â‚¹' + (rev).toLocaleString('en-IN') + '/mo' : 'â€”'}</span>
                </div>`;
            }).join('');

            // Recent signups
            const recent = [...allClients].slice(0, 10);
            document.getElementById('recentSignups').innerHTML = recent.length ? recent.map(c => {
                const joined = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
                const initial = (c.company_name || c.email || 'C')[0].toUpperCase();
                return `<div class="signup-item">
                    <div class="signup-left">
                        <div class="signup-avatar">${esc(initial)}</div>
                        <div>
                            <div class="signup-name">${esc(c.company_name || c.email || 'â€”')}</div>
                            <div class="signup-date">${esc(c.email || '')}</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${getPlanTag(c.plan)}
                        <span style="font-size:12px;color:#9ca3af;">${joined}</span>
                        ${getStatusBadge(c.subscription_status, c.is_active)}
                    </div>
                </div>`;
            }).join('') : '<p style="color:#9ca3af;font-size:13px;">No signups yet.</p>';
        }

        // ============================================================
        // STATS
        // ============================================================
        function updateStats() {
            let mrr = 0;
            allClients.forEach(c => {
                const price = PLAN_PRICES[(c.plan||'free').toLowerCase()] || 0;
                if (price > 0 && c.is_active) mrr += price;
            });
            document.getElementById('statTotalClients').textContent  = allClients.length;
            document.getElementById('statActiveClients').textContent = allClients.filter(c => c.is_active).length;
            document.getElementById('statTotalShipments').textContent = allShipments.length;
            document.getElementById('statMRR').textContent = 'â‚¹' + mrr.toLocaleString('en-IN');
        }

        // ============================================================
        // CLIENT ACTIONS
        // ============================================================
        function viewClient(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;
            const shipmentCount = allShipments.filter(s => s.client_id === id).length;
            const joined = c.created_at ? new Date(c.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';

            document.getElementById('modalTitle').textContent = c.company_name || c.email;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">Company</span><span class="detail-value">${esc(c.company_name||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">Owner</span><span class="detail-value">${esc(c.owner_name||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${esc(c.email||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">Phone</span><span class="detail-value">${esc(c.phone||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">AWB Prefix</span><span class="detail-value">${esc(c.awb_prefix||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">AWB Counter</span><span class="detail-value">${c.awb_counter||0}</span></div>
                <div class="detail-row"><span class="detail-label">Plan</span><span class="detail-value">${getPlanTag(c.plan)}</span></div>
                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value">${getStatusBadge(c.subscription_status, c.is_active)}</span></div>
                <div class="detail-row"><span class="detail-label">Shipments</span><span class="detail-value">${shipmentCount}</span></div>
                <div class="detail-row"><span class="detail-label">Joined</span><span class="detail-value">${joined}</span></div>
                <div class="detail-row"><span class="detail-label">Client ID</span><span class="detail-value" style="font-size:11px;font-family:monospace;">${esc(c.id)}</span></div>
            `;
            document.getElementById('modalActions').innerHTML = `
                <button class="btn-secondary" onclick="closeClientModal()">Close</button>
                <button class="btn-warning"   onclick="closeClientModal(); editClient('${id}')">Edit Details</button>
                ${c.is_active
                    ? `<button class="btn-danger" onclick="toggleClient('${id}', false); closeClientModal()">Suspend</button>`
                    : `<button class="btn-success" onclick="toggleClient('${id}', true); closeClientModal()">Activate</button>`
                }
            `;
            document.getElementById('clientModal').style.display = 'flex';
        }

        function editClient(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('modalTitle').textContent = 'Edit â€” ' + (c.company_name || c.email);
            document.getElementById('modalBody').innerHTML = `
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">Company Name</label>
                        <input class="modal-input" id="editCompany" value="${esc(c.company_name||'')}">
                    </div>
                    <div class="form-field">
                        <label class="form-label">Owner Name</label>
                        <input class="modal-input" id="editOwner" value="${esc(c.owner_name||'')}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">Phone</label>
                        <input class="modal-input" id="editPhone" value="${esc(c.phone||'')}">
                    </div>
                    <div class="form-field">
                        <label class="form-label">AWB Prefix</label>
                        <input class="modal-input" id="editAwbPrefix" value="${esc(c.awb_prefix||'')}" maxlength="5" style="text-transform:uppercase">
                    </div>
                </div>
                <div class="form-field">
                    <label class="form-label">Reset AWB Counter to</label>
                    <input class="modal-input" id="editAwbCounter" type="number" min="1" value="${c.awb_counter||1}">
                    <span style="font-size:12px;color:#9ca3af;margin-top:4px;">Current: ${c.awb_counter||0} â€” change only if you need to reset</span>
                </div>
            `;
            document.getElementById('modalActions').innerHTML = `
                <button class="btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn-success" onclick="saveEditClient('${id}')">Save Changes</button>
            `;
            document.getElementById('clientModal').style.display = 'flex';
        }

        async function saveEditClient(id) {
            const company    = document.getElementById('editCompany').value.trim();
            const owner      = document.getElementById('editOwner').value.trim();
            const phone      = document.getElementById('editPhone').value.trim();
            const awbPrefix  = document.getElementById('editAwbPrefix').value.trim().toUpperCase();
            const awbCounter = parseInt(document.getElementById('editAwbCounter').value) || 1;

            if (!company) { alert('Company name is required.'); return; }

            const { error } = await window.supabaseClient
                .from('clients')
                .update({ company_name: company, owner_name: owner, phone, awb_prefix: awbPrefix, awb_counter: awbCounter })
                .eq('id', id);

            if (error) { alert('Error saving: ' + error.message); return; }

            const idx = allClients.findIndex(x => x.id === id);
            if (idx !== -1) {
                allClients[idx] = { ...allClients[idx], company_name: company, owner_name: owner, phone, awb_prefix: awbPrefix, awb_counter: awbCounter };
            }

            closeClientModal();
            filterClients();
            updateStats();
        }

        function changePlan(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;

            document.getElementById('modalTitle').textContent = 'Plan & Status â€” ' + (c.company_name || c.email);
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">Company</span><span class="detail-value">${esc(c.company_name||'â€”')}</span></div>
                <div class="detail-row"><span class="detail-label">Current Plan</span><span class="detail-value">${getPlanTag(c.plan)}</span></div>
                <div class="detail-row">
                    <span class="detail-label">New Plan</span>
                    <select class="modal-select" id="newPlanSelect" style="width:auto;">
                        <option value="free"    ${c.plan==='free'   ?'selected':''}>Free â€” â‚¹0</option>
                        <option value="starter" ${c.plan==='starter'?'selected':''}>Starter â€” â‚¹999/mo</option>
                        <option value="growth"  ${c.plan==='growth' ?'selected':''}>Growth â€” â‚¹2,499/mo</option>
                        <option value="pro"     ${c.plan==='pro'    ?'selected':''}>Pro â€” â‚¹4,999/mo</option>
                    </select>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Subscription Status</span>
                    <select class="modal-select" id="newStatusSelect" style="width:auto;">
                        <option value="trial"     ${(c.subscription_status||'')==='trial'    ?'selected':''}>Trial</option>
                        <option value="active"    ${(c.subscription_status||'')==='active'   ?'selected':''}>Active</option>
                        <option value="inactive"  ${(c.subscription_status||'')==='inactive' ?'selected':''}>Inactive</option>
                        <option value="suspended" ${(c.subscription_status||'')==='suspended'?'selected':''}>Suspended</option>
                        <option value="pending"   ${(c.subscription_status||'')==='pending'  ?'selected':''}>Pending</option>
                    </select>
                </div>
            `;
            document.getElementById('modalActions').innerHTML = `
                <button class="btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn-success"   onclick="savePlanChange('${id}')">Save Changes</button>
            `;
            document.getElementById('clientModal').style.display = 'flex';
        }

        async function savePlanChange(id) {
            const plan   = document.getElementById('newPlanSelect').value;
            const status = document.getElementById('newStatusSelect').value;
            const isActive = (status === 'active' || status === 'trial');

            const { error } = await window.supabaseClient
                .from('clients')
                .update({ plan, subscription_status: status, is_active: isActive })
                .eq('id', id);

            if (error) { alert('Error saving: ' + error.message); return; }

            const idx = allClients.findIndex(x => x.id === id);
            if (idx !== -1) { allClients[idx].plan = plan; allClients[idx].subscription_status = status; allClients[idx].is_active = isActive; }

            closeClientModal();
            filterClients();
            updateStats();
        }

        async function toggleClient(id, activate) {
            if (!confirm(`Are you sure you want to ${activate ? 'activate' : 'suspend'} this account?`)) return;

            const { error } = await window.supabaseClient
                .from('clients')
                .update({ is_active: activate })
                .eq('id', id);

            if (error) { alert('Error: ' + error.message); return; }

            const idx = allClients.findIndex(x => x.id === id);
            if (idx !== -1) allClients[idx].is_active = activate;

            filterClients();
            updateStats();
        }

        async function deleteClient(id) {
            const c = allClients.find(x => x.id === id);
            if (!c) return;

            const confirmed = confirm(
                `DELETE "${c.company_name || c.email}"?\n\n` +
                `This will permanently delete the client record and ALL their shipments.\n` +
                `This action cannot be undone.\n\nType OK to confirm.`
            );
            if (!confirmed) return;

            // Delete shipments first (FK constraint)
            const { error: shipErr } = await window.supabaseClient
                .from('shipments')
                .delete()
                .eq('client_id', id);

            if (shipErr) { alert('Error deleting shipments: ' + shipErr.message); return; }

            // Delete client record
            const { error: clientErr } = await window.supabaseClient
                .from('clients')
                .delete()
                .eq('id', id);

            if (clientErr) { alert('Error deleting client: ' + clientErr.message); return; }

            allClients     = allClients.filter(x => x.id !== id);
            allShipments   = allShipments.filter(x => x.client_id !== id);

            filterClients();
            filterShipments();
            updateStats();
        }

        function closeClientModal() { document.getElementById('clientModal').style.display = 'none'; }
        function closeModalOnOverlay(e) { if (e.target === document.getElementById('clientModal')) closeClientModal(); }

        // ============================================================
        // LOGOUT
        // ============================================================
        function handleLogout() {
            if (!confirm('Sign out of Super Admin?')) return;
            sessionStorage.removeItem(SESSION_KEY);
            window.location.href = 'super-admin-login.html';
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function esc(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function getStatusKey(subscription_status, is_active) {
            if (!is_active) return 'suspended';
            return (subscription_status || 'pending').toLowerCase();
        }

        function getStatusBadge(subscription_status, is_active) {
            const key = getStatusKey(subscription_status, is_active);
            const labels = { active:'Active', trial:'Trial', suspended:'Suspended', inactive:'Inactive', pending:'Pending' };
            const cls    = { active:'badge-active', trial:'badge-trial', suspended:'badge-suspended', inactive:'badge-inactive', pending:'badge-pending' };
            return `<span class="badge ${cls[key]||'badge-pending'}">${labels[key]||key}</span>`;
        }

        function getPlanTag(plan) {
            const p = (plan||'free').toLowerCase();
            const labels = { free:'Free', starter:'Starter', growth:'Growth', pro:'Pro' };
            return `<span class="plan-tag plan-${p}">${labels[p]||p}</span>`;
        }

        function getShipmentBadge(status) {
            const map = {
                'Delivered':'badge-delivered','In Transit':'badge-transit',
                'Out for Delivery':'badge-transit','Booked':'badge-booked',
                'Picked Up':'badge-pickup','On Hold':'badge-hold',
            };
            return `<span class="badge ${map[status]||'badge-booked'}">${esc(status||'â€”')}</span>`;
        }
    </script>
</body>
</html>
